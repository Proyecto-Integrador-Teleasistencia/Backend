name: CI/CD Laravel API Deployment

on:
  push:
    branches:
      - main  

jobs:
  deploy:
    name: ðŸš€ Desplegar API Laravel en AWS
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ðŸ“¥ Acceder al servidor y actualizar el cÃ³digo
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USER }}
          key: ${{ secrets.AWS_SSH_KEY }}
          script: |
            DEPLOY_DIR="/var/www/back"
            REPO_URL="https://${{ secrets.GH_PAT }}@github.com/Proyecto-Integrador-Teleasistencia/Backend.git"

            if [ ! -d "$DEPLOY_DIR/.git" ]; then
              echo "ðŸ“¥ Clonando el repositorio en $DEPLOY_DIR..."
              git clone $REPO_URL $DEPLOY_DIR
            else
              echo "ðŸ”„ El repositorio ya existe. Haciendo pull..."
              cd $DEPLOY_DIR
              git reset --hard origin/main  # Restablecer cambios locales
              git pull origin main
            fi

            sudo chown -R $USER:$USER $DEPLOY_DIR
